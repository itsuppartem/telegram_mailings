
# Mailing Processor

## 1. Краткое описание

Микросервис `Mailing Processor` предназначен для асинхронной обработки и отправки массовых рассылок пользователям через Telegram API. Сервис периодически опрашивает базу данных MongoDB на предмет наличия новых или приостановленных задач на рассылку, обрабатывает их с использованием многопроцессорности для повышения производительности и отказоустойчивости, а также управляет статусами рассылок и формирует отчеты о доставке.

## 2. Архитектура и технологии

*   **Язык программирования:** Python 3.
*   **Основной фреймворк/библиотеки:**
    *   `asyncio`: Используется для построения асинхронной логики, что критически важно для I/O-bound операций, таких как сетевые запросы к Telegram API и взаимодействие с базой данных. Это позволяет эффективно обрабатывать множество задач одновременно без блокировки основного потока.
    *   `multiprocessing`: Применяется для распределения нагрузки по отправке сообщений в рамках одной крупной рассылки между несколькими процессами (воркерами). Это позволяет утилизировать ресурсы многоядерных процессоров и значительно ускорить процесс рассылки.
    *   `motor`: Асинхронный драйвер для MongoDB, выбранный для неблокирующего взаимодействия с базой данных в рамках `asyncio` событийного цикла.
    *   `httpx`: Современный асинхронный HTTP-клиент для взаимодействия с Telegram Bot API.
    *   `backoff`: Библиотека для реализации стратегий повторных попыток при сбоях запросов к Telegram API (например, при временных сетевых ошибках или превышении лимитов).
    *   `asyncio-throttle`: Используется для ограничения частоты запросов к Telegram API, чтобы избежать блокировки со стороны Telegram.
    *   `pytz`: Для корректной обработки временных зон, в частности, при проверке временных окон для отправки рассылок.
*   **База данных:** MongoDB. Выбрана из-за гибкости схемы данных, что удобно для хранения информации о рассылках (тексты, медиа, списки получателей, статусы, промокоды), и хорошей производительности при работе с большими объемами данных.
*   **API протокол (взаимодействие):** Сервис взаимодействует с Telegram Bot API (REST-подобный HTTP API) для отправки сообщений. Внутреннее управление задачами осуществляется через документы в MongoDB.
*   **Аутентификация:**
    *   **Telegram API:** Используются токены ботов Telegram, которые указываются в конфигурации сервиса или получаются динамически на основе имени бота, указанного в задаче на рассылку.
    *   **MongoDB:** Данные для подключения к MongoDB (строка подключения) задаются через переменную окружения.

**Принципы работы:**
Сервис работает в цикле, опрашивая коллекцию `mailings` в MongoDB. При обнаружении рассылки со статусом, допускающим запуск ("Готова к запуску", "Готова к продолжению"), и если она не обрабатывается в данный момент, сервис инициирует ее обработку. Обработка включает разделение списка получателей на батчи, запуск дочерних процессов для параллельной отправки сообщений и обновление статусов в MongoDB. Сервис также учитывает заданные временные окна для отправки.



## 3. Примеры использования (Сценарии работы)

Сервис `Mailing Processor` не предоставляет внешнего API для управления рассылками. Управление осуществляется путем создания и модификации документов в коллекции `mailings` базы данных `mailing_db` в MongoDB.

### 3.1. Создание задачи на рассылку

Чтобы инициировать новую рассылку, необходимо создать документ в коллекции `mailings` со следующей структурой:

```json
{
  "name": "UniqueMailingName_SummerPromo2024", // Уникальное имя рассылки
  "bot": "ko", // Имя бота ('ko' или 'vroom'), определяет используемые токены
  "text": "Привет! Специальное летнее предложение для вас! ☀️",
  "photo": "AgADBAADx6cxG079CQABs82X2TnYAffH_CoABAI0AAQjBA", // Опционально: Telegram File ID фотографии
  "animation": null, // Опционально: Telegram File ID анимации (GIF)
  "receivers_ids": [123456789, 987654321, 112233445], // Полный список chat_id получателей
  "pending_receivers_ids": [123456789, 987654321, 112233445], // Список chat_id, которым еще не отправлено
  "sent_count": 0,
  "failed_count": 0,
  "status": "Готова к запуску", // Начальный статус
  "time_spoon": [9, 21], // Опционально: временное окно для отправки [start_hour, end_hour] по МСК (с 9:00 до 20:59)
  "promo_codes": { // Опционально: карта промокодов { "номер_телефона_пользователя": "промокод" }
    "79161234567": "SUMMER20",
    "79267654321": "SALE15"
  },
  "launch_history": [], // Заполняется автоматически
  "report": null // Заполняется автоматически по завершении
}
```

**Пояснения к полям:**
*   `name`: Строка. Уникальный идентификатор рассылки.
*   `bot`: Строка. Идентификатор бота (`"ko"` или `"vroom"`), для которого предназначена рассылка. Сервис использует это поле для выбора соответствующих токенов Telegram.
*   `text`: Строка. Основной текст сообщения. Поддерживает HTML-разметку для Telegram.
*   `photo`: Строка (опционально). Telegram `file_id` для фотографии. Если указано, сообщение будет отправлено как фото с подписью (`caption`).
*   `animation`: Строка (опционально). Telegram `file_id` для анимации. Если указано (и `photo` отсутствует), сообщение будет отправлено как анимация с подписью.
*   `receivers_ids`: Массив чисел. Изначальный полный список `chat_id` пользователей, которым предназначена рассылка.
*   `pending_receivers_ids`: Массив чисел. Список `chat_id` пользователей, которым еще предстоит отправить сообщение. Изначально копия `receivers_ids`. По мере отправки `chat_id` удаляются из этого списка.
*   `sent_count`, `failed_count`: Числа. Счетчики успешно отправленных и неудавшихся сообщений. Обновляются сервисом.
*   `status`: Строка. Текущий статус рассылки. Возможные значения:
    *   `"Готова к запуску"`: Новая рассылка, ожидает обработки.
    *   `"Выполняется"`: Рассылка в процессе отправки.
    *   `"Готова к продолжению"`: Рассылка была частично выполнена и ожидает следующего цикла обработки (например, после паузы из-за `time_spoon`).
    *   `"Ждет следующего дня"`: Отправка приостановлена до наступления следующего разрешенного временного окна (`time_spoon`).
    *   `"Завершена"`: Все сообщения отправлены, или не осталось получателей.
    *   `"Ошибка"`: В процессе обработки произошла критическая ошибка.
*   `time_spoon`: Массив из двух чисел (опционально). Определяет временное окно (часы по московскому времени), в течение которого разрешена отправка сообщений. Например, `[9, 18]` означает отправку с 9:00 до 17:59 МСК. Если не указано, отправка разрешена круглосуточно.
*   `promo_codes`: Объект (опционально). Карта, где ключ — номер телефона пользователя (в формате строки, например, `"79001234567"`), а значение — персональный промокод. Сервис попытается сопоставить `chat_id` с номером телефона (из других коллекций MongoDB, логика в `get_user_phone_worker`) и добавить промокод к тексту сообщения.

### 3.2. Ход выполнения рассылки

1.  После создания документа со статусом `"Готова к запуску"`, сервис `Mailing Processor` в течение `POLL_INTERVAL_SECONDS` обнаружит его.
2.  Статус рассылки будет изменен на `"Выполняется"`. Текущее время будет добавлено в `launch_history`.
3.  Сервис оценит, сколько сообщений можно отправить в текущем цикле, учитывая `time_spoon` и количество доступных воркеров.
4.  Список `pending_receivers_ids` будет разделен на батчи (`BATCH_SIZE_PER_WORKER`).
5.  Для каждого батча будет запущен отдельный процесс-воркер (`message_sender_process_entrypoint`).
    *   Воркер попытается отправить сообщения каждому `chat_id` из своего батча.
    *   Если для `chat_id` найден соответствующий промокод в `promo_codes` (через сопоставление с номером телефона), он будет добавлен к тексту сообщения.
    *   Будут использованы токены, соответствующие полю `bot`. При ошибке 403 (бот заблокирован пользователем) для одного токена, будет предпринята попытка с другим токеном этого же бота.
    *   Попытки отправки защищены механизмами `backoff` (для ошибок типа 429 - Too Many Requests) и `asyncio-throttle` (для общего ограничения скорости).
6.  После завершения работы всех воркеров, основной процесс обновит документ рассылки в MongoDB:
    *   Обновятся `sent_count` и `failed_count`.
    *   Обработанные `chat_id` будут удалены из `pending_receivers_ids`.
7.  Дальнейший статус рассылки:
    *   Если `pending_receivers_ids` пуст, статус станет `"Завершена"`, и будет сформирован объект `report` с итогами.
    *   Если `pending_receivers_ids` не пуст, но текущее время вышло за рамки `time_spoon`, статус станет `"Ждет следующего дня"`.
    *   Если `pending_receivers_ids` не пуст и `time_spoon` позволяет, статус станет `"Готова к продолжению"`, и рассылка будет подхвачена в следующем цикле опроса.
    *   При возникновении невосстановимой ошибки в основном потоке обработки рассылки, статус может стать `"Ошибка"`, и в поле `last_error_message` будет записано сообщение об ошибке.

### 3.3. Пример отчета по завершении рассылки (`report`)

Когда рассылка успешно завершена, поле `report` в документе рассылки может выглядеть так:

```json
{
  "report": {
    "total_sent": 1230,
    "total_failed": 5,
    "duration_seconds": 125.67,
    "start_time": "2024-07-15T10:00:05.123Z", // ISODate
    "end_time": "2024-07-15T10:02:10.793Z"   // ISODate
  }
}
```
